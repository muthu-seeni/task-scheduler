{% extends "layout.html" %}
{% block title %}My Tasks{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <!-- Task Form -->
    <div class="col-md-6 mb-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 id="formTitle" class="card-title mb-3 text-center">âž• Add New Task</h5>
          <form method="POST" id="taskForm" action="{{ url_for('main.tasks') }}">
            <input type="hidden" name="task_id" id="taskId">

            <!-- Title -->
            <div class="input-group mb-3">
              <input class="form-control" name="title" id="taskTitle" placeholder="Task title">
              <button type="button" class="btn btn-outline-secondary" id="micTitleBtn">
                <i class="bi bi-mic-fill"></i>
              </button>
            </div>

            <!-- Time -->
            <div class="input-group mb-3">
              <input type="time" name="time" id="taskTime" class="form-control">
              <button type="button" class="btn btn-outline-secondary" id="micTimeBtn">
                <i class="bi bi-mic-fill"></i>
              </button>
            </div>

            <!-- Action -->
            <div class="input-group mb-3">
              <input class="form-control" name="action" id="taskAction"
                     placeholder="Task action (what to do)" list="actionOptions">
              <datalist id="actionOptions">
                <option value="Wake me up">
                <option value="Remind me">
                <option value="Check email">
                <option value="Meeting reminder">
              </datalist>
              <button type="button" class="btn btn-outline-secondary" id="micActionBtn">
                <i class="bi bi-mic-fill"></i>
              </button>
            </div>

            <div id="actionButtons" class="mt-2"></div>

            <button id="taskSubmitBtn" class="btn btn-primary w-100">Add Task</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Task List -->
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title mb-3 text-center">ðŸ“‹ Task List</h5>
          {% if tasks %}
            <ul class="list-group" id="taskList">
              {% for task in tasks %}
                <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap"
                    data-type="{{ 'grocery' if task.notification_type == 'grocery' else 'task' }}"
                    data-id="{{ task.id }}"
                    data-notify="{{ 'true' if task.notify_enabled else 'false' }}">
                  <div class="task-info">
                    <strong>{{ task.title }}</strong> â€” {{ task.time }} <br>
                    <small class="text-muted task-action-text">{{ task.action }}</small>
                  </div>

                  <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-warning edit-task"
                            data-id="{{ task.id }}"
                            data-title="{{ task.title }}"
                            data-time="{{ task.time }}"
                            data-action="{{ task.action }}">
                      <i class="bi bi-pencil"></i>
                    </button>

                    <form method="POST" action="{{ url_for('main.delete_task', task_id=task.id) }}">
                      <button class="btn btn-outline-danger">
                        <i class="bi bi-trash"></i>
                      </button>
                    </form>

                    <button type="button" class="btn btn-outline-secondary toggle-notif"
                            title="Toggle Notification">
                      <!-- JS will set the correct icon on load -->
                      ðŸ””
                    </button>
                  </div>
                </li>
              {% endfor %}
            </ul>

            <form method="POST" action="{{ url_for('main.clear_tasks') }}" class="mt-3 text-center">
              <button class="btn btn-outline-danger btn-sm">Clear All Tasks</button>
            </form>
          {% else %}
            <p class="text-center text-muted">No tasks yet. Add your first task on the left.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
<!-- Note: socket should be initialized in layout.html once -->
<script src="{{ url_for('static', filename='js/tasks.js') }}"></script>
{% endblock %}
